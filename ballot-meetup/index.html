<!doctype>
<html>

<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="promise.min.js"></script>
<script type="text/javascript" src="ethereum.js"></script>
<script type="text/javascript">

var web3 = require('web3');
web3.setProvider(new web3.providers.AutoProvider());

// contract description, copied from AlethZero
var contractInterface =[{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"voteAgainst","outputs":[]},{"constant":false,"inputs":[{"name":"description","type":"string32"}],"name":"createProposal","outputs":[{"name":"id","type":"uint256"}]},{"constant":true,"inputs":[],"name":"getNumProposals","outputs":[{"name":"num","type":"uint256"}]},{"constant":false,"inputs":[{"name":"id","type":"uint256"}],"name":"voteFor","outputs":[]},{"constant":true,"inputs":[{"name":"id","type":"uint256"}],"name":"getProposal","outputs":[{"name":"description","type":"string32"},{"name":"votesFor","type":"uint256"},{"name":"votesAgainst","type":"uint256"}]}];


var contract;
$(function() {
  $("#ballotAddress").change(function() {
    contract = web3.contract('0x' + $("#ballotAddress").val(), contractInterface);
    web3.watch({altered: '0x' + $("#ballotAddress").val()}).changed(function() {
                updateView(); });
    updateView();
  });
  $("#updateView").click(function(ev) {
    ev.preventDefault();
    contract = web3.contract('0x' + $("#ballotAddress").val(), contractInterface);
    web3.eth.watch({altered: '0x' + $("#ballotAddress").val()}).changed(function() {
                updateView(); });
    updateView();
    return false;
  });
  $("#createProposal").click(function(ev) {
    ev.preventDefault();
    contract.createProposal($("#description").val()).transact().then(function(res) {
      updateView();
    });
    return false;
  });
});
function updateView()
{
  contract.getNumProposals().call().then(function(num) {
    $('#numProposals').text(num);
    $('#proposalContainer').empty();
    for (var i = 0; i < num; i++) {
      $('#proposalContainer').append('<div id="proposal-' + i + '"/>');
      updateProposal(i);
    }
  });
};
function updateProposal(i)
{
  contract.getProposal(i).call().then(function(proposal) {
      console.log(proposal);
    var c = $('#proposal-' + i);
    c.empty();
    c.append("Description: ")
     .append($('<span/>').text(proposal[0]))
     .append("<br/>Votes for: ")
     .append($('<span/>').text(proposal[1]))
     .append("<br/>Votes against: ")
     .append($('<span/>').text(proposal[2]))
     .append($('<button id="voteFor-' + i + '">vote for</button>').click(function() {
             contract.voteFor(i).transact().then(function() {
                 updateView();
             });
            }))
     .append($('<button id="voteAgainst-' + i + '">vote against</button>').click(function() {
             contract.voteAgainst(i).transact().then(function() {
                 updateView();
             });
           }))
     .append('<hr/>');
  });
};

/*    var contract;

    function createExampleContract() {
        // hide create button
        document.getElementById('create').style.visibility = 'hidden'; 
        document.getElementById('source').innerText = source;

        // create contract
        web3.eth.transact({code: web3.eth.solidity(source)}).then(function (address) {
            contract = web3.contract(address, desc);
            document.getElementById('call').style.visibility = 'visible';
        });
    }

    function callExampleContract() {
        // this should be generated by ethereum
        var param = parseInt(document.getElementById('value').value);

        // call the contract
        contract.multiply(param).call().then(function(res) {
            document.getElementById('result').innerText = res[0];
        });
    }
*/
</script>
</head>
<body>
<h1>Ballot</h1>
<form class="form-inline">
<div class="form-group">
  <input type="email" class="form-control" id="ballotAddress" placeholder="Enter ballot contract address">
  <button id="updateView" class="btn btn-default">Update</button>
</div>
</form>
<h2>New Proposal</h2>
<form class="form-inline">
  <input type="text" class="form-control" id="description" placeholder="Description">
  <button id="createProposal" class="btn btn-default">Create</button>
</form>
<h2>Proposals</h2>
<div>Number of proposals: <span id="numProposals"></span></div>
<div id="proposalContainer"></div>
<h2>Messages</h2>
<div id="messageContainer">
</div>
</body>
</html>

